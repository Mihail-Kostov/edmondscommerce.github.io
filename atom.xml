<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Edmonds Commerce Dev Blog]]></title>
  <link href="http://edmondscommerce.github.io/atom.xml" rel="self"/>
  <link href="http://edmondscommerce.github.io/"/>
  <updated>2015-02-11T16:19:12+00:00</updated>
  <id>http://edmondscommerce.github.io/</id>
  <author>
    <name><![CDATA[EdmondsCommerce Development Team]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[SUPEE-5344 - a New Patch for Magento Community 1.6, 1.7, 1.8 and 1.9; Enterprise 1.11, 1.12, 1.13 and 1.14]]></title>
    <link href="http://edmondscommerce.github.io/magento/supee-5344-a-new-patch-for-magento-community-1-dot-6-1-dot-7-1-dot-8-and-1-dot-9-enterprise-1-dot-11-1-dot-12-1-dot-13-and-1-dot-14.html"/>
    <updated>2015-02-11T15:53:28+00:00</updated>
    <id>http://edmondscommerce.github.io/magento/supee-5344-a-new-patch-for-magento-community-1-dot-6-1-dot-7-1-dot-8-and-1-dot-9-enterprise-1-dot-11-1-dot-12-1-dot-13-and-1-dot-14</id>
    <content type="html"><![CDATA[<p>Magento has become aware of a vulnerability requiring patching as soon as possible. The vulnerability allows an attacker to send a specially crafted request to a Magento store and allow it to run Magento code as though it were on the live server. Magento aren&rsquo;t aware of this having been used in the wild, but now that the vulnerability is public, attackers may use it against existing stores.</p>

<p>This vulnerability affects all versions of Magento, and Magento have released patches for versions Community Edition 1.6 to 1.9, and Enterprise 1.11 to 1.14.</p>

<p>The fix is to apply some stricter IP address checks to requests.</p>

<h3>Patching your Magento store</h3>

<p>To get the patch:</p>

<p><em>Note: at time of writing, the Downloads of the CE edition seems to under heavy load and is currently presenting a white page instead of the shell file</em></p>

<ul>
<li><strong>Community Edition</strong> users should go to the <a href="http://www.magentocommerce.com/download">Magento downloads page</a> and scroll to the &ldquo;Magento Community Edition Patches&rdquo; section. From there, select your version of Magento and click Download</li>
<li><strong>Enterprise Edition</strong> users should log into their Magento account Magento Support Portal</li>
</ul>


<p>You&rsquo;ll be presented with a shell file which will make the necessary changes to your store. Upload this patch to your server in the Magento root and run it against your store.</p>

<p>The patch changes core files, and it&rsquo;s always recommended to test changes on a development copy before the live site, especially if you have modifications to your core code. Also keep in mind that any upgrades pre-1.9.0.1 will remove these changes, and the patch will have to be re-run.</p>

<ol>
<li><code>cd /your/magento/root/</code> &ndash; Navigate to the root of Magento</li>
<li><code>./sh PATCH_SUPEE-5344_CE_1.8.0.0_v1.sh</code> &ndash; Run the patches</li>
<li><code>rm PATCH_SUPEE-5344_CE_1.8.0.0_v1.sh</code> &ndash; Delete the patch file, so that it can&rsquo;t be re-run by the public</li>
<li><code>rm -rf var/cache/*</code> &ndash; Clear Magento&rsquo;s cache</li>
</ol>


<p>Reload a page and the patch will have taken effect.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[SUPEE-3941 - A new patch for Magento Community 1.6, 1.7, 1.8 and 1.9; Enterprise 1.11, 1.12, 1.13 and 1.14]]></title>
    <link href="http://edmondscommerce.github.io/magento/supee-3941-a-new-patch-for-magento-community-1-dot-6-1-dot-7-1-dot-8-and-1-dot-9-enterprise-1-dot-11-1-dot-12-1-dot-13-and-1-dot-14.html"/>
    <updated>2015-02-11T10:54:06+00:00</updated>
    <id>http://edmondscommerce.github.io/magento/supee-3941-a-new-patch-for-magento-community-1-dot-6-1-dot-7-1-dot-8-and-1-dot-9-enterprise-1-dot-11-1-dot-12-1-dot-13-and-1-dot-14</id>
    <content type="html"><![CDATA[<p>This post was published with the incorrect vulnerability code; <a href="http://edmondscommerce.github.io/magento/supee-5344-a-new-patch-for-magento-community-1-dot-6-1-dot-7-1-dot-8-and-1-dot-9-enterprise-1-dot-11-1-dot-12-1-dot-13-and-1-dot-14.html">this article has been moved to this post</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Behat and emulating mobile browsers using chrome]]></title>
    <link href="http://edmondscommerce.github.io/Behat/behat-and-emulating-mobile-browsers-using-chrome.html"/>
    <updated>2015-02-03T13:00:25+00:00</updated>
    <id>http://edmondscommerce.github.io/Behat/behat-and-emulating-mobile-browsers-using-chrome</id>
    <content type="html"><![CDATA[<p>Lets admit it not all mobile sites are responsive as they were created when responsive sites were in their infancy or just did not exist. Along with that and even if a site is responsive some elements, images, styles and javascript maybe exclusive to mobile user agents or excluded all together due to file size concerns.</p>

<p>It would be useful to test a site when it is dealing with a mobile user agent. However you don not always need a actual mobile browser thanks to chromes mobile device emulation. Although it is not useful it can at lest be used to do some testing when site responds to specific user agents. Chromes mobile emulation can be driven with behat using the following example:</p>

<figure class='code panel panel-default'><figcaption class='panel-heading'><h3 class='panel-title'></h3></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">default</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">extensions</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">Behat\MinkExtension</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">base_url</span><span class="p-Indicator">:</span> <span class="s">&quot;http://urltotest.com/&quot;</span>
</span><span class='line'>      <span class="l-Scalar-Plain">default_session</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">selenium_firefox_session</span>
</span><span class='line'>      <span class="l-Scalar-Plain">goutte</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">~</span>
</span><span class='line'>      <span class="l-Scalar-Plain">sessions</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="l-Scalar-Plain">goutte_session</span><span class="p-Indicator">:</span>
</span><span class='line'>          <span class="l-Scalar-Plain">goutte</span><span class="p-Indicator">:</span>
</span><span class='line'>            <span class="l-Scalar-Plain">guzzle_parameters</span><span class="p-Indicator">:</span>
</span><span class='line'>              <span class="l-Scalar-Plain">ssl.certificate_authority</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">false</span>
</span><span class='line'>        <span class="l-Scalar-Plain">selenium_chrome_mobile_session</span><span class="p-Indicator">:</span>
</span><span class='line'>          <span class="l-Scalar-Plain">selenium2</span><span class="p-Indicator">:</span>
</span><span class='line'>            <span class="l-Scalar-Plain">browser</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">chrome</span>
</span><span class='line'>            <span class="l-Scalar-Plain">capabilities</span><span class="p-Indicator">:</span>
</span><span class='line'>              <span class="l-Scalar-Plain">extra_capabilities</span><span class="p-Indicator">:</span>
</span><span class='line'>                <span class="l-Scalar-Plain">chromeOptions</span><span class="p-Indicator">:</span>
</span><span class='line'>                  <span class="l-Scalar-Plain">mobileEmulation</span><span class="p-Indicator">:</span>
</span><span class='line'>                    <span class="l-Scalar-Plain">deviceName</span><span class="p-Indicator">:</span> <span class="s">&quot;Google</span><span class="nv"> </span><span class="s">Nexus</span><span class="nv"> </span><span class="s">5&quot;</span>
</span><span class='line'>        <span class="l-Scalar-Plain">selenium_chrome_session</span><span class="p-Indicator">:</span>
</span><span class='line'>          <span class="l-Scalar-Plain">selenium2</span><span class="p-Indicator">:</span>
</span><span class='line'>            <span class="l-Scalar-Plain">browser</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">chrome</span>
</span><span class='line'>            <span class="l-Scalar-Plain">capabilities</span><span class="p-Indicator">:</span>
</span><span class='line'>              <span class="l-Scalar-Plain">extra_capabilities</span><span class="p-Indicator">:</span>
</span><span class='line'>                <span class="l-Scalar-Plain">chromeOptions</span><span class="p-Indicator">:</span>
</span><span class='line'>                  <span class="l-Scalar-Plain">args</span><span class="p-Indicator">:</span>
</span><span class='line'>                    <span class="p-Indicator">-</span> <span class="s">&quot;--start-maximized&quot;</span>
</span><span class='line'>                    <span class="p-Indicator">-</span> <span class="s">&quot;--test-type&quot;</span>
</span><span class='line'>        <span class="l-Scalar-Plain">selenium_firefox_session</span><span class="p-Indicator">:</span>
</span><span class='line'>          <span class="l-Scalar-Plain">selenium2</span><span class="p-Indicator">:</span>
</span><span class='line'>            <span class="l-Scalar-Plain">browser</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">firefox</span>
</span><span class='line'>  <span class="l-Scalar-Plain">suites</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">my_suite</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">contexts</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">FeatureContext</span>
</span><span class='line'>        <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">Behat\MinkExtension\Context\MinkContext</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">chrome_mobile</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">extensions</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">Behat\MinkExtension</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">default_session</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">selenium_chrome_mobile_session</span>
</span></code></pre></td></tr></table></div></figure>


<p>With Behat and Mink we are able to pass extra parameters to the chrome selnium driver using the extra_capabilities options. In the above example we enable mobile emulation using the &ldquo;Google Nexus 5&rdquo; profile. To drive tests using this we have two options.</p>

<p>Specify the profile at run time using:</p>

<figure class='code panel panel-default'><figcaption class='panel-heading'><h3 class='panel-title'></h3></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>bin/behat -p chrome
</span></code></pre></td></tr></table></div></figure>


<p>Alternative you can tag specific scenarios to use a given profile by using the following tag above the scenario you want to affect:</p>

<figure class='code panel panel-default'><figcaption class='panel-heading'><h3 class='panel-title'></h3></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>@mink:selenium_chrome_mobile_session
</span></code></pre></td></tr></table></div></figure>


<p></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Multiple Behat and Mink profiles for testing multiple browsers]]></title>
    <link href="http://edmondscommerce.github.io/Behat/multiple-behat-and-mink-profiles-for-testing-multiple-browsers.html"/>
    <updated>2015-02-03T12:20:36+00:00</updated>
    <id>http://edmondscommerce.github.io/Behat/multiple-behat-and-mink-profiles-for-testing-multiple-browsers</id>
    <content type="html"><![CDATA[<p>Behat makes it easy to write and run automated testing in browser and in most cases where functionality is not javascript driven then testing in a single browser is fine.</p>

<p>However if you are testing Javascript driven functionality then it is best to have multiple profiles for multiple browsers without having to write the scenario multiple times with different tagsi for different sessions. Luckily behat support defination of multiple profiles which inherit from a single default profile for all your browser needs. You simply need to set up your bhat yaml config file like so:</p>

<figure class='code panel panel-default'><figcaption class='panel-heading'><h3 class='panel-title'></h3></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">default</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">extensions</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">Behat\MinkExtension</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">base_url</span><span class="p-Indicator">:</span> <span class="s">&quot;http://someurl.com&quot;</span>
</span><span class='line'>      <span class="l-Scalar-Plain">default_session</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">selenium_firefox_session</span>
</span><span class='line'>      <span class="l-Scalar-Plain">goutte</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">~</span>
</span><span class='line'>      <span class="l-Scalar-Plain">sessions</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="l-Scalar-Plain">goutte_session</span><span class="p-Indicator">:</span>
</span><span class='line'>          <span class="l-Scalar-Plain">goutte</span><span class="p-Indicator">:</span>
</span><span class='line'>            <span class="l-Scalar-Plain">guzzle_parameters</span><span class="p-Indicator">:</span>
</span><span class='line'>              <span class="l-Scalar-Plain">ssl.certificate_authority</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">false</span>
</span><span class='line'>        <span class="l-Scalar-Plain">selenium_chrome_session</span><span class="p-Indicator">:</span>
</span><span class='line'>          <span class="l-Scalar-Plain">selenium2</span><span class="p-Indicator">:</span>
</span><span class='line'>            <span class="l-Scalar-Plain">browser</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">chrome</span>
</span><span class='line'>        <span class="l-Scalar-Plain">selenium_firefox_session</span><span class="p-Indicator">:</span>
</span><span class='line'>          <span class="l-Scalar-Plain">selenium2</span><span class="p-Indicator">:</span>
</span><span class='line'>            <span class="l-Scalar-Plain">browser</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">firefox</span>
</span><span class='line'>  <span class="l-Scalar-Plain">suites</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">my_suite</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">contexts</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">FeatureContext</span>
</span><span class='line'>        <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">Behat\MinkExtension\Context\MinkContext</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">chrome</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">extensions</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">Behat\MinkExtension</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">default_session</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">selenium_chrome_session</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">firefox</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">extensions</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">Behat\MinkExtension</span><span class="p-Indicator">:</span>
</span><span class='line'>      <span class="l-Scalar-Plain">default_session</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">selenium_firefox_session</span>
</span></code></pre></td></tr></table></div></figure>


<p>The to run the crome profile for example use the -p option flag on the behat command as show:</p>

<figure class='code panel panel-default'><figcaption class='panel-heading'><h3 class='panel-title'></h3></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>bin/behat -p chrome
</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[PageSpeed and issue with images on Safari]]></title>
    <link href="http://edmondscommerce.github.io/PageSpeed/pagespeed-and-issue-with-images-on-safari.html"/>
    <updated>2015-01-30T16:15:13+00:00</updated>
    <id>http://edmondscommerce.github.io/PageSpeed/pagespeed-and-issue-with-images-on-safari</id>
    <content type="html"><![CDATA[<p>Had an issue on a client site where the images were working in all major browser with the exception of safari. The client had page speed installed with the &lsquo;rewrite_images&rsquo; filter enabled.
So it would work with older versions of Safari there are two options:</p>

<p>For the first option we can disable the &lsquo;convert_jpeg_to_webp&rsquo; and &lsquo;convert_to_webp_lossless&rsquo; filters in nginx by using the following after the &lsquo;rewrite_images&rsquo; and &lsquo;resize_rendered_image_dimensions&rsquo; filters:</p>

<pre><code>pagespeed EnableFilters rewrite_images;
pagespeed EnableFilters resize_rendered_image_dimensions;
pagespeed DisableFilters convert_jpeg_to_webp,convert_to_webp_lossless;
</code></pre>

<p>In Apache use the following:</p>

<pre><code>ModPagespeedDisableFilters convert_jpeg_to_webp,convert_to_webp_lossless
</code></pre>

<p>Please not that the diable option must be specified after the enable lines for &lsquo;rewrite_images&rsquo; and &lsquo;resize_rendered_image_dimensions&rsquo; filters.</p>

<p>In versions of PageSpeed that are 1.8.31.2 and above there is a new option which is &lsquo;ServeRewrittenWebpUrlsToAnyAgent&rsquo; which will check to see if the client can support webp files on any webp urls that are accessed.</p>

<p>In Nginx to enable this option:</p>

<pre><code>pagespeed ServeRewrittenWebpUrlsToAnyAgent off;
</code></pre>

<p>Alternatively in apache the setting is:</p>

<pre><code>ModPagespeedServeRewrittenWebpUrlsToAnyAgent off
</code></pre>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Varnish and Nginx redirecting to port 8080]]></title>
    <link href="http://edmondscommerce.github.io/nginx/varnish/varnish-and-nginx-redirecting-to-port-8080.html"/>
    <updated>2015-01-23T15:22:43+00:00</updated>
    <id>http://edmondscommerce.github.io/nginx/varnish/varnish-and-nginx-redirecting-to-port-8080</id>
    <content type="html"><![CDATA[<p>So theres a strange problem where any redirects are going port 8080 when running your web application or site under varnish and nginx. Now arroung the web the solution apears to have varnish listen locally on port 80 while leaving nginx to listen on port 80 for any network addresses. The issue is that nginx when doing a redirect will add the port automatically to any redirect specified in nginx or is triggered from php, this is so that you dont have to ajust your rewrites if you are running on a non standard web port. But in the case of running varnish on top we dont want this behaviour to happen.</p>

<p>To stop this in the location, server or http context of your nginx config. Simply add:</p>

<figure class='code panel panel-default'><figcaption class='panel-heading'><h3 class='panel-title'></h3></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>port_in_redirect off;
</span></code></pre></td></tr></table></div></figure>


<p>As by default according to the <a href="http://nginx.org/en/docs/http/ngx_http_core_module.html#port_in_redirect">nginx documentation</a> this behaviour is on by default.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Combined CSV]]></title>
    <link href="http://edmondscommerce.github.io/bash/combined-csv.html"/>
    <updated>2014-12-10T17:23:36+00:00</updated>
    <id>http://edmondscommerce.github.io/bash/combined-csv</id>
    <content type="html"><![CDATA[<p>Here is a quick BASH one liner to combine a folder of csv or similar files into one combined file with a header.</p>

<figure class='code panel panel-default'><figcaption class='panel-heading'><h3 class='panel-title'></h3></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">h</span><span class="o">=</span>0; <span class="k">for </span>f in *; <span class="k">do if</span> <span class="o">[[</span> 0 !<span class="o">=</span> <span class="nv">$h</span> <span class="o">]]</span>; <span class="k">then </span>tail -n +2 <span class="nv">$f</span> &gt;&gt; combined.txt; <span class="k">else </span>cat <span class="nv">$f</span> &gt; combined.txt; <span class="nv">h</span><span class="o">=</span>1; <span class="k">fi done</span>
</span></code></pre></td></tr></table></div></figure>


<p>More readably, you can see it like this:</p>

<figure class='code panel panel-default'><figcaption class='panel-heading'><h3 class='panel-title'></h3></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># has header been set, starts as no</span>
</span><span class='line'><span class="nv">h</span><span class="o">=</span>0;
</span><span class='line'><span class="c"># foreach file in current directory</span>
</span><span class='line'><span class="k">for </span>f in *
</span><span class='line'><span class="k">do</span>
</span><span class='line'>    <span class="c"># if header has been set</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">[[</span> 0 !<span class="o">=</span> <span class="nv">$h</span> <span class="o">]]</span>
</span><span class='line'>    <span class="k">then</span>
</span><span class='line'>        <span class="c"># append the contents of the file starting from line 2 into the combined file</span>
</span><span class='line'>        tail -n +2 <span class="nv">$f</span> &gt;&gt; combined.txt
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>        <span class="c"># overwrite the combined file with the contents of the file, including header</span>
</span><span class='line'>        cat <span class="nv">$f</span> &gt; combined.txt
</span><span class='line'>        <span class="c"># and mark the header as having been set</span>
</span><span class='line'>        <span class="nv">h</span><span class="o">=</span>1
</span><span class='line'>    <span class="k">fi </span>
</span><span class='line'><span class="k">done</span>
</span></code></pre></td></tr></table></div></figure>


<p>That&rsquo;s it, pretty easy really</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Bash Script to Kill Sleeping MySQL Processes]]></title>
    <link href="http://edmondscommerce.github.io/bash/bash-script-to-kill-sleeping-mysql-processes.html"/>
    <updated>2014-12-08T12:52:03+00:00</updated>
    <id>http://edmondscommerce.github.io/bash/bash-script-to-kill-sleeping-mysql-processes</id>
    <content type="html"><![CDATA[<p>Pretty much what is says on the tin, if for some reason you have a large amount of sleeping MySQL processes and you want to quickly clear them all out, this little BASH script will do the job.</p>

<p>I leave it to you to decide how to handle the DBUSER and DBPASS variables</p>

<figure class='code panel panel-default'><figcaption class='panel-heading'><h3 class='panel-title'></h3></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#!/bin/bash</span>
</span><span class='line'>mysql -u <span class="nv">$DBUSER</span> -p<span class="nv">$DBPASS</span> -e <span class="s2">&quot;</span>
</span><span class='line'><span class="s2">select </span>
</span><span class='line'><span class="s2">-- * </span>
</span><span class='line'><span class="s2">id</span>
</span><span class='line'><span class="s2">from information_schema.processlist </span>
</span><span class='line'><span class="s2">where command = &#39;Sleep&#39; </span>
</span><span class='line'><span class="s2">and time &gt; 1 </span>
</span><span class='line'><span class="s2">and host =&#39;localhost&#39;</span>
</span><span class='line'><span class="s2">&quot;</span> | <span class="k">while </span><span class="nb">read </span>id;
</span><span class='line'><span class="k">do </span>
</span><span class='line'><span class="k">    if</span> <span class="o">[[</span> <span class="s2">&quot;id&quot;</span> <span class="o">==</span> <span class="s2">&quot;$id&quot;</span> <span class="o">]]</span>
</span><span class='line'>    <span class="k">then</span>
</span><span class='line'><span class="k">        continue</span>
</span><span class='line'><span class="k">    fi</span>
</span><span class='line'><span class="k">    </span><span class="nb">echo</span> <span class="s2">&quot;kill $id&quot;</span>;
</span><span class='line'>    mysql -u <span class="nv">$DBUSER</span> -p<span class="nv">$DBPASS</span> -e <span class="s2">&quot;kill $id&quot;</span>;
</span><span class='line'><span class="k">done</span>
</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Blocking Direct IP Access in Apache]]></title>
    <link href="http://edmondscommerce.github.io/apache/blocking-direct-ip-access-in-apache.html"/>
    <updated>2014-12-03T15:08:37+00:00</updated>
    <id>http://edmondscommerce.github.io/apache/blocking-direct-ip-access-in-apache</id>
    <content type="html"><![CDATA[<p>If you are using Name based virtual hosts, you may want to simply block any bots etc that try to access your server by direct IP address. It&rsquo;s unlikely a real user would try to hit your server by using the actual IP address.</p>

<p>To do this, you can use this Virtual Host config:</p>

<figure class='code panel panel-default'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;VirtualHost *:80&gt;
</span><span class='line'>    ServerName 123.123.123.123
</span><span class='line'>    Redirect 403 /
</span><span class='line'>    ErrorDocument 403 "No"
</span><span class='line'>    DocumentRoot /dev/null/
</span><span class='line'>    UseCanonicalName Off
</span><span class='line'>    UserDir disabled
</span><span class='line'>&lt;/VirtualHost&gt;
</span></code></pre></td></tr></table></div></figure>


<p>Of course, please change the IP to the real server IP address(es)</p>

<p>And that&rsquo;s it, anyone trying to hit the server by IP address will get a simple 403 error.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Composer Run Utility BASH Script]]></title>
    <link href="http://edmondscommerce.github.io/composer/composer-run-utility-bash-script.html"/>
    <updated>2014-11-25T09:18:18+00:00</updated>
    <id>http://edmondscommerce.github.io/composer/composer-run-utility-bash-script</id>
    <content type="html"><![CDATA[<p>I thought I would post up this little snippet of BASH script that I tend to use with projects that use composer.</p>

<p>It combines an install/update mechanism for composer itself and then runs through the composer install process and dumps the optimised autoloader.</p>

<p>Hope you find it useful:</p>

<figure class='code panel panel-default'><figcaption class='panel-heading'><h3 class='panel-title'></h3></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#!/bin/bash</span>
</span><span class='line'><span class="nv">DIR</span><span class="o">=</span><span class="s2">&quot;$( cd &quot;</span><span class="k">$(</span> dirname <span class="s2">&quot;${BASH_SOURCE[0]}&quot;</span> <span class="k">)</span><span class="s2">&quot; &amp;&amp; pwd )&quot;</span>
</span><span class='line'><span class="nb">echo</span> <span class="s2">&quot;Checking for Composer&quot;</span>
</span><span class='line'><span class="nv">COMPOSER_CMD</span><span class="o">=</span><span class="k">$(</span>which composer<span class="k">)</span>
</span><span class='line'><span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;&quot;</span> <span class="o">==</span> <span class="s2">&quot;$COMPOSER_CMD&quot;</span> <span class="o">]]</span>
</span><span class='line'><span class="k">then</span>
</span><span class='line'><span class="k">    </span><span class="nb">echo</span> <span class="s2">&quot;Installing Composer&quot;</span>
</span><span class='line'>    curl -sS https://getcomposer.org/installer | php -- --install-dir<span class="o">=</span>bin
</span><span class='line'>    <span class="nv">COMPOSER_CMD</span><span class="o">=</span><span class="k">$(</span>which composer<span class="k">)</span>
</span><span class='line'><span class="k">else</span>
</span><span class='line'><span class="k">    </span><span class="nb">echo</span> <span class="s2">&quot;Updating Composer&quot;</span>
</span><span class='line'>    <span class="nv">$COMPOSER_CMD</span> selfupdate
</span><span class='line'><span class="k">fi</span>
</span><span class='line'><span class="nb">echo</span> <span class="s2">&quot;Running Composer&quot;</span>
</span><span class='line'><span class="nb">cd</span> <span class="nv">$DIR</span>
</span><span class='line'><span class="nv">$COMPOSER_CMD</span> update
</span><span class='line'><span class="nv">$COMPOSER_CMD</span> dumpautoload -o
</span><span class='line'><span class="nb">echo</span> <span class="s2">&quot;Done..&quot;</span>
</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Getting sub domains and domain from a url]]></title>
    <link href="http://edmondscommerce.github.io/php/getting-sub-domains-and-domain-from-a-url.html"/>
    <updated>2014-11-14T13:34:08+00:00</updated>
    <id>http://edmondscommerce.github.io/php/getting-sub-domains-and-domain-from-a-url</id>
    <content type="html"><![CDATA[<p>At first it seems like a simple one &ndash; just use the <code>parse_url</code> function already built into PHP.</p>

<p>Unfortunately though, this just gives you the host &ndash; which is usually a combination of a subdomain &ndash; such as www &ndash; and the domain itself.</p>

<p>To resolve this I ended up writing the following code. It will gradually snip bits off the start of a host and then make a HTTP request until that request fails.</p>

<p>Once it fails, we know that we have snipped off all of the sub domains we can and we have our final domain.</p>

<p>Here is the code:</p>

<figure class='code panel panel-default'><figcaption class='panel-heading'><h3 class='panel-title'></h3></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="k">public</span> <span class="k">function</span> <span class="nf">getDomain</span><span class="p">(</span><span class="nv">$url</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_domain</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nv">$host</span> <span class="o">=</span> <span class="nb">parse_url</span><span class="p">(</span><span class="nv">$url</span><span class="p">,</span> <span class="nx">PHP_URL_HOST</span><span class="p">);</span>
</span><span class='line'>        <span class="nv">$sanity</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getHeadersForUrl</span><span class="p">(</span><span class="nv">$host</span><span class="p">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$sanity</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">throw</span> <span class="k">new</span> <span class="nx">ErrorException</span><span class="p">(</span><span class="s2">&quot;No headers when sanity checking full host: </span><span class="si">$host</span><span class="s2"> in &quot;</span> <span class="o">.</span> <span class="nx">__METHOD__</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="nv">$elems</span> <span class="o">=</span> <span class="nb">explode</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="nv">$host</span><span class="p">);</span>
</span><span class='line'>        <span class="nv">$subdomains</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
</span><span class='line'>        <span class="nv">$domain</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span>
</span><span class='line'>        <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="nv">$domain</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="nv">$check</span> <span class="o">=</span> <span class="nb">implode</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="nv">$elems</span><span class="p">);</span>
</span><span class='line'>            <span class="nv">$headers</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getHeadersForUrl</span><span class="p">(</span><span class="nv">$check</span><span class="p">);</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="nv">$headers</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="nv">$subdomains</span><span class="p">[]</span> <span class="o">=</span> <span class="nb">array_shift</span><span class="p">(</span><span class="nv">$elems</span><span class="p">);</span>
</span><span class='line'>            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>                <span class="nb">array_unshift</span><span class="p">(</span><span class="nv">$elems</span><span class="p">,</span> <span class="nb">array_pop</span><span class="p">(</span><span class="nv">$subdomains</span><span class="p">));</span>
</span><span class='line'>                <span class="nv">$domain</span> <span class="o">=</span> <span class="nb">implode</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="nv">$elems</span><span class="p">);</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_domain</span> <span class="o">=</span> <span class="nv">$domain</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">_domain</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">public</span> <span class="k">function</span> <span class="nf">getHeadersForUrl</span><span class="p">(</span><span class="nv">$url</span><span class="p">,</span> <span class="nv">$followOnLocation</span> <span class="o">=</span> <span class="k">true</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="nv">$ch</span> <span class="o">=</span> <span class="nb">curl_init</span><span class="p">();</span>
</span><span class='line'>    <span class="nb">curl_setopt</span><span class="p">(</span><span class="nv">$ch</span><span class="p">,</span> <span class="nx">CURLOPT_URL</span><span class="p">,</span> <span class="nv">$url</span><span class="p">);</span>
</span><span class='line'>    <span class="nb">curl_setopt</span><span class="p">(</span><span class="nv">$ch</span><span class="p">,</span> <span class="nx">CURLOPT_HEADER</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span>
</span><span class='line'>    <span class="nb">curl_setopt</span><span class="p">(</span><span class="nv">$ch</span><span class="p">,</span> <span class="nx">CURLOPT_NOBODY</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span>
</span><span class='line'>    <span class="nb">curl_setopt</span><span class="p">(</span><span class="nv">$ch</span><span class="p">,</span> <span class="nx">CURLOPT_RETURNTRANSFER</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span>
</span><span class='line'>    <span class="nb">curl_setopt</span><span class="p">(</span><span class="nv">$ch</span><span class="p">,</span> <span class="nx">CURLOPT_FOLLOWLOCATION</span><span class="p">,</span> <span class="nv">$followOnLocation</span><span class="p">);</span>
</span><span class='line'>    <span class="nb">curl_setopt</span><span class="p">(</span><span class="nv">$ch</span><span class="p">,</span> <span class="nx">CURLOPT_MAXREDIRS</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
</span><span class='line'>    <span class="nb">curl_setopt</span><span class="p">(</span><span class="nv">$ch</span><span class="p">,</span> <span class="nx">CURLOPT_SSL_VERIFYPEER</span><span class="p">,</span> <span class="k">false</span><span class="p">);</span>
</span><span class='line'>    <span class="nb">curl_setopt</span><span class="p">(</span><span class="nv">$ch</span><span class="p">,</span> <span class="nx">CURLOPT_SSL_VERIFYHOST</span><span class="p">,</span> <span class="k">false</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="nv">$data</span> <span class="o">=</span> <span class="nb">curl_exec</span><span class="p">(</span><span class="nv">$ch</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="nv">$data</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[SSL testing and SHA-1 Sunsetting]]></title>
    <link href="http://edmondscommerce.github.io/security/ssl-testing-and-sha-1-sunsetting.html"/>
    <updated>2014-11-12T13:03:36+00:00</updated>
    <id>http://edmondscommerce.github.io/security/ssl-testing-and-sha-1-sunsetting</id>
    <content type="html"><![CDATA[<p>Over last few days we been doing a bit of work on doing some audits for people and one of the things that has come up is ssl. For the purpose of checking the servers ssl implementation we have been using <a href="https://www.ssllabs.com/ssltest/">Qualys SSL Labs</a> which is a excelent tool.</p>

<p>The checker checks for the ssl certificate and tells you if your server setup is vulnerable to attacks such as Poodle and OpenSSL CCS Injection. We will produce a blog post shortly on the best practise setup to prevent these attcks.</p>

<p>For the moment SHA-1 as a certificate signature algorithm is getting depricated in <a href="https://community.qualys.com/blogs/securitylabs/2014/09/09/sha1-deprecation-what-you-need-to-know">chrome</a>. As the cost for collision attcks against SHA-1 will become more <a href="https://www.schneier.com/blog/archives/2012/10/when_will_we_se.html">affordable</a> in the next few years.</p>

<p>Goole have set the cut off for certificates after 2016 but we will be seeing some crosses on the padlock in chrom during the first quater of 2015.</p>

<p>If your certificate expires in 2015 then you will not see any chrome. If your certificate expires in 2016 you will see some minor errors being reported in chrome. However if your certificate expires in 2017 then chrome will treat it as an insecure certificate in 2015.</p>

<p>So our advice is:</p>

<ul>
<li>If your certificate expires in 2015: When you come to renew make sure you get SHA-256 as the certificate signature</li>
<li>If your certificate expires in 2016: Think about getting renewed during 2015 or earlier.</li>
<li>If your certificate expires in 2017: Think about getting a new one issue as soon as possible.</li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[atop quick start: an introduction to atop snapshotting]]></title>
    <link href="http://edmondscommerce.github.io/atop-quick-start-an-introduction-to-atop-snapshotting.html"/>
    <updated>2014-11-12T12:35:43+00:00</updated>
    <id>http://edmondscommerce.github.io/atop-quick-start-an-introduction-to-atop-snapshotting</id>
    <content type="html"><![CDATA[<p><a href="http://www.atoptool.nl/"><code>atop</code></a> is a server diagnostic tool to take snapshots of the server&rsquo;s activity at specified intervals, so it&rsquo;s useful for debugging intermitttent issues without watching the server constantly.</p>

<p><code>atop</code> is available to install from the repos with a <code>yum install atop</code> or <code>apt-get install</code> atop depending if you&rsquo;re on a RedHat or Debian-based server. By default atop will take snapshots every 10 minutes.</p>

<p>Omnce it&rsquo;s been left running, you can view its snapshots by running <code>atop -r /var/log/atop/atop_&lt;date&gt;</code> &ndash; you can see the dates that are logged by listing the <code>/var/log/atop</code> directory.</p>

<p>Two key commands to use are <code>b</code> and <code>t</code>. Pressing <code>b</code> will prompt for a time in the format hh:mm. Enter a time and it&rsquo;ll jump to the nearest snapshot. From there <code>t</code> and <code>T</code> (<code>shift-t</code>) will jump you forwards and backwards through the logs respectively</p>

<p>This is an example of atop&rsquo;s output:</p>

<figure class='code panel panel-default'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>
</span><span class='line'>ATOP - ip-10-0-1-22                                                          2014/11/11  00:30:02                                                          -----------                                                           10m0s elapsed
</span><span class='line'>PRC | sys    5.11s  | user  10.94s |               |              | #proc    104  | #trun      1 |               | #tslpi   149 |  #tslpu     0 |              |  #zombie    0 | clones    37 |               |              |  #exit     46 |
</span><span class='line'>CPU | sys 1%  | user  2% |               | irq       0% |               | idle    197% |               | wait      0% |               |              |  steal     0% | guest     0% |  curf 2.50GHz |              |  curscal   ?% |
</span><span class='line'>cpu | sys 1%  | user  1% |               | irq       0% |               | idle     98% |               | cpu001 w  0% |               |              |  steal     0% | guest     0% |  curf 2.50GHz |              |  curscal   ?% |
</span><span class='line'>cpu | sys 0%  | user  0% |               | irq       0% |               | idle     99% |               | cpu000 w  0% |               |              |  steal     0% | guest     0% |  curf 2.50GHz |              |  curscal   ?% |
</span><span class='line'>CPL | avg1    0.14  |              | avg5    0.09  |              | avg15   0.07  |              |               | csw   261923 |               | intr  279857 |               |              |               | numcpu     2 |               |
</span><span class='line'>MEM | tot     7.3G  | free    5.8G | cache 176.1M  | dirty   0.8M | buff   14.2M  | slab   41.4M | slrec  20.1M  | shmem  36.9M |  shrss   0.0M | shswp   0.0M |               | vmbal   0.0M |               | hptot   0.0M |  hpuse   0.0M |
</span><span class='line'>SWP | tot     0.0M  | free    0.0M |               |              |               |              |               |              |               |              |               |              |  vmcom   2.1G | vmlim   3.6G |               |
</span><span class='line'>NET | transport     | tcpi   69012 | tcpo   74002  |              | udpi      93  | udpo      97 | tcpao     72  | tcppo    330 |               | tcprs    250 |  tcpie      0 | tcpor     24 |  udpnp      0 |              |  udpie    0 |
</span><span class='line'>NET | network       | ipi    69105 |               | ipo    74025 | ipfrw      0  |              | deliv  69105  |              |               |              |               |              |  icmpi      0 | icmpo    0 |               |
</span><span class='line'>NET | eth0    ----  | pcki   68732 |               | pcko   73654 | si  342 Kbps  | so  464 Kbps |               | coll       0 |  mlti       0 |              |  erri       0 | erro       0 |  drpi       0 |              |  drpo     0 |
</span><span class='line'>NET | lo      ----  | pcki     396 |               | pcko     396 | si   17 Kbps  | so   17 Kbps |               | coll       0 |  mlti       0 |              |  erri       0 | erro       0 |  drpi       0 |              |  drpo     0 |
</span><span class='line'>Window resized to 238x71...
</span><span class='line'>  PID          TID         RUID             EUID              THR         SYSCPU         USRCPU          VGROW          RGROW          RDDSK          WRDSK         ST         EXC         S         CPUNR          CPU         CMD        1/3
</span><span class='line'> 1335            -         root             root                7          2.51s          2.97s             0K             0K             0K             0K         --           -         S             1           1%         glusterfs
</span><span class='line'>17247            -         apache           apache              1          0.40s          4.34s         46644K         66352K          3340K          3292K         --           -         S             1           1%         httpd
</span><span class='line'>17274            -         apache           apache              1          0.36s          1.13s         35236K         54628K          1188K          2304K         --           -         S             0           0%         httpd
</span><span class='line'>17267            -         apache           apache              1          0.24s          0.94s         55204K         83040K          2348K          2760K         --           -         S             1           0%         httpd
</span><span class='line'>17310            -         apache           apache              1          0.26s          0.49s         961.9M         83508K           548K            12K         N-           -         S             1           0%         httpd
</span><span class='line'>16708            -         varnish          varnish            19          0.28s          0.08s          4992K          5188K         32588K           448K         --           -         S             0           0%         varnishd
</span><span class='line'>17248            -         apache           apache              1          0.11s          0.17s          7128K         24120K           364K          1788K         --           -         S             1           0%         httpd
</span><span class='line'>17187            -         root             root                1          0.18s          0.04s           140K           140K             0K            24K         --           -         R             1           0%         atop
</span><span class='line'> 1418            -         root             root                7          0.11s          0.10s             0K             0K             0K             0K         --           -         S             1           0%         glusterfs
</span><span class='line'>17309            -         apache           apache              1          0.06s          0.10s         922.2M         25716K           820K             8K         N-           -         S             0           0%         httpd
</span><span class='line'> 1460            -         root             root                7          0.07s          0.08s             0K             0K             0K             0K         --           -         S             1           0%         glusterfs
</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Compile NGINX with PageSpeed and ModSecurity on CentOS]]></title>
    <link href="http://edmondscommerce.github.io/linux/compile-nginx-with-pagespeed-and-modsecurity-on-centos.html"/>
    <updated>2014-11-11T14:06:37+00:00</updated>
    <id>http://edmondscommerce.github.io/linux/compile-nginx-with-pagespeed-and-modsecurity-on-centos</id>
    <content type="html"><![CDATA[<p>ModSecurity is a brilliant addition to web servers to block any nefarious requests before they hit your application.
This improves security and reduces load if your server comes under attack as the requests are killed very quickly.</p>

<p>PageSpeed is a module provided by Google to automatically improve the performance of your web pages in the browser. In a stroke it can offer a much more responsive front end with just a few configuration options.</p>

<p>Nginx is a very fast and lightweight web server ideal for using with back end servers such as PHP-FPM.</p>

<p>Here is a script that will download and compile Nginx with the two modules and also apply the correct ModSecurity configuration.</p>

<figure class='code panel panel-default'><figcaption class='panel-heading'><h3 class='panel-title'></h3></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#!/bin/bash</span>
</span><span class='line'><span class="nb">echo</span> <span class="s2">&quot;Please run as root&quot;</span>
</span><span class='line'>yum install gcc-c++ pcre-dev pcre-devel zlib-devel make unzip
</span><span class='line'>
</span><span class='line'><span class="nv">NPS_VERSION</span><span class="o">=</span>1.9.32.2;
</span><span class='line'>
</span><span class='line'><span class="nv">NGINX_VERSION</span><span class="o">=</span>1.7.7;
</span><span class='line'>
</span><span class='line'><span class="nv">MODSEC_VERSION</span><span class="o">=</span>2.8.0
</span><span class='line'>
</span><span class='line'><span class="nv">NGINX_EXTRA_MODULES</span><span class="o">=</span><span class="s2">&quot; --with-http_realip_module --with-http_ssl_module &quot;</span>;
</span><span class='line'>
</span><span class='line'><span class="nv">NGINX_ADD_MODULES</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="nv">WORKING_DIRECTORY</span><span class="o">=</span>/opt/nginx_with_pagespeed_and_mod_security
</span><span class='line'>
</span><span class='line'>mkdir -p <span class="nv">$WORKING_DIRECTORY</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="nb">echo</span> <span class="s2">&quot;</span>
</span><span class='line'><span class="s2">===============================================================================</span>
</span><span class='line'>
</span><span class='line'><span class="s2">Mod Security</span>
</span><span class='line'>
</span><span class='line'><span class="s2">Installing dependencies, grabbing the repo, checking out the tag for our version and building it</span>
</span><span class='line'><span class="s2">------------&quot;</span>
</span><span class='line'><span class="nb">cd</span> <span class="nv">$WORKING_DIRECTORY</span>
</span><span class='line'>yum install libtool httpd-devel libxml2 libxml2-devel
</span><span class='line'>git clone https://github.com/SpiderLabs/ModSecurity.git
</span><span class='line'><span class="nb">cd </span>ModSecurity
</span><span class='line'>git checkout tags/v<span class="k">${</span><span class="nv">MODSEC_VERSION</span><span class="k">}</span>
</span><span class='line'>./autogen.sh
</span><span class='line'>./configure --enable-standalone-module --disable-mlogc
</span><span class='line'>make
</span><span class='line'>make install
</span><span class='line'><span class="nv">NGINX_ADD_MODULES</span><span class="o">=</span><span class="s2">&quot;$NGINX_ADD_MODULES --add-module=$WORKING_DIRECTORY/ModSecurity/nginx/modsecurity &quot;</span>
</span><span class='line'><span class="nb">echo</span> <span class="s2">&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="s2">Mod Security Config and Rules</span>
</span><span class='line'><span class="s2">-----------------------------</span>
</span><span class='line'>
</span><span class='line'><span class="s2">For nginx, we have to get all the config and cat it all into one single config file</span>
</span><span class='line'><span class="s2">&quot;</span>
</span><span class='line'>wget https://raw.githubusercontent.com/SpiderLabs/ModSecurity/master/modsecurity.conf-recommended
</span><span class='line'>cat modsecurity.conf-recommended  &gt; /etc/nginx/modsecurity.conf
</span><span class='line'>wget https://github.com/SpiderLabs/owasp-modsecurity-crs/tarball/master -O owasp-modsecurity-crs.tar.gz
</span><span class='line'>tar -xvzf owasp-modsecurity-crs.tar.gz
</span><span class='line'><span class="nv">CRS_DIR</span><span class="o">=</span><span class="k">$(</span>find . -type d -name SpiderLabs-owasp-modsecurity-crs*<span class="k">)</span>
</span><span class='line'>cat <span class="k">${</span><span class="nv">CRS_DIR</span><span class="k">}</span>/modsecurity_crs_10_setup.conf.example &gt;&gt; /etc/nginx/modsecurity.conf
</span><span class='line'>cat <span class="k">${</span><span class="nv">CRS_DIR</span><span class="k">}</span>/base_rules/modsecurity_*.conf &gt;&gt; /etc/nginx/modsecurity.conf
</span><span class='line'><span class="k">for </span>f in <span class="k">$(</span>find <span class="nv">$CRS_DIR</span> -type f -name *.data<span class="k">)</span>
</span><span class='line'><span class="k">do</span>
</span><span class='line'><span class="k">    </span><span class="nv">FILE</span><span class="o">=</span><span class="k">$(</span>basename <span class="nv">$f</span><span class="k">)</span>
</span><span class='line'>    <span class="nv">CMD</span><span class="o">=</span><span class="s2">&quot;cp $f /etc/nginx/$FILE&quot;</span>
</span><span class='line'>    <span class="nb">echo</span> <span class="k">${</span><span class="nv">CMD</span><span class="k">}</span>
</span><span class='line'>    <span class="k">${</span><span class="nv">CMD</span><span class="k">}</span>
</span><span class='line'><span class="k">done</span>
</span><span class='line'>cp ModSecurity/unicode.mapping /etc/nginx/unicode.mapping
</span><span class='line'>
</span><span class='line'><span class="nb">echo</span> <span class="s2">&quot;</span>
</span><span class='line'><span class="s2">===============================================================================</span>
</span><span class='line'>
</span><span class='line'><span class="s2">Page Speed</span>
</span><span class='line'><span class="s2">----------</span>
</span><span class='line'>
</span><span class='line'><span class="s2">Downlading the pagespeed version and building this</span>
</span><span class='line'><span class="s2">&quot;</span>
</span><span class='line'><span class="nb">cd</span> <span class="nv">$WORKING_DIRECTORY</span>
</span><span class='line'>wget https://github.com/pagespeed/ngx_pagespeed/archive/release-<span class="k">${</span><span class="nv">NPS_VERSION</span><span class="k">}</span>-beta.zip
</span><span class='line'>unzip release-<span class="k">${</span><span class="nv">NPS_VERSION</span><span class="k">}</span>-beta.zip
</span><span class='line'><span class="nb">cd </span>ngx_pagespeed-release-<span class="k">${</span><span class="nv">NPS_VERSION</span><span class="k">}</span>-beta/
</span><span class='line'>wget https://dl.google.com/dl/page-speed/psol/<span class="k">${</span><span class="nv">NPS_VERSION</span><span class="k">}</span>.tar.gz
</span><span class='line'>tar -xzvf <span class="k">${</span><span class="nv">NPS_VERSION</span><span class="k">}</span>.tar.gz  <span class="c"># extracts to psol/</span>
</span><span class='line'><span class="nv">NGINX_ADD_MODULES</span><span class="o">=</span><span class="s2">&quot;$NGINX_ADD_MODULES --add-module=$WORKING_DIRECTORY/ngx_pagespeed-release-${NPS_VERSION}-beta &quot;</span>
</span><span class='line'>
</span><span class='line'><span class="nb">echo</span> <span class="s2">&quot;</span>
</span><span class='line'><span class="s2">===============================================================================</span>
</span><span class='line'>
</span><span class='line'><span class="s2">Nginx</span>
</span><span class='line'><span class="s2">-----</span>
</span><span class='line'><span class="s2">Finally, compiling Nginx with our extra modules and the added modules and installing it</span>
</span><span class='line'><span class="s2">&quot;</span>
</span><span class='line'><span class="nb">cd</span> <span class="nv">$WORKING_DIRECTORY</span>
</span><span class='line'>wget http://nginx.org/download/nginx-<span class="k">${</span><span class="nv">NGINX_VERSION</span><span class="k">}</span>.tar.gz
</span><span class='line'>tar -xvzf nginx-<span class="k">${</span><span class="nv">NGINX_VERSION</span><span class="k">}</span>.tar.gz
</span><span class='line'><span class="nb">cd </span>nginx-<span class="k">${</span><span class="nv">NGINX_VERSION</span><span class="k">}</span>/
</span><span class='line'>./configure <span class="nv">$NGINX_ADD_MODULES</span> <span class="nv">$NGINX_EXTRA_MODULES</span>
</span><span class='line'>make
</span><span class='line'>sudo make install
</span><span class='line'>
</span><span class='line'><span class="nb">echo</span> <span class="s2">&quot;</span>
</span><span class='line'><span class="s2">===============================================================================</span>
</span><span class='line'>
</span><span class='line'><span class="s2">COMPLETED INSTALL - CHECKING</span>
</span><span class='line'>
</span><span class='line'><span class="s2">checking the nginx version now, should be $NGINX_VERSION and you should see our modules</span>
</span><span class='line'><span class="s2">&quot;</span>
</span><span class='line'>nginx -V
</span><span class='line'>
</span><span class='line'><span class="nb">echo</span> <span class="s2">&quot;</span>
</span><span class='line'><span class="s2">And now doing a config test&quot;</span>
</span><span class='line'>/etc/init.d/nginx configtest
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="nb">echo</span> <span class="s2">&quot;</span>
</span><span class='line'><span class="s2">===============================================================================</span>
</span><span class='line'>
</span><span class='line'><span class="s2">SCRIPT COMPLETED</span>
</span><span class='line'>
</span><span class='line'><span class="s2">However, you are not there yet</span>
</span><span class='line'>
</span><span class='line'><span class="s2">You need to go and look at the /etc/nginx/modsecurity.conf file and change settings there as appropriate</span>
</span><span class='line'>
</span><span class='line'><span class="s2">Also you need to modify your nginx vhost config - see:</span>
</span><span class='line'><span class="s2">https://github.com/SpiderLabs/ModSecurity/wiki/Reference-Manual#Configuration_Steps</span>
</span><span class='line'><span class="s2">&quot;</span>
</span></code></pre></td></tr></table></div></figure>



]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[SELinux and connecting to Mysql databases on Red Hat based distributions]]></title>
    <link href="http://edmondscommerce.github.io/linux/se-linux-and-connecting-to-a-mysql-database.html"/>
    <updated>2014-11-07T10:53:06+00:00</updated>
    <id>http://edmondscommerce.github.io/linux/se-linux-and-connecting-to-a-mysql-database</id>
    <content type="html"><![CDATA[<p>SELinux can be restrictive by defult but prevent alot of security issues. One thing we found while trying it is that by default it will block network connections from being made via the httpd daemon. This is an issue if say on a development system you are running php via the apache module.</p>

<p>To resolve this simply login via root or sudo to root privilige and run the following command:</p>

<pre><code>setsebool -P httpd_can_network_connect on
</code></pre>

<p>You should now be able to connect to connect to your database. This will also enable things like web api, curl calls and other php that requires network access.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[PHP error checking in Vim with Syntastic]]></title>
    <link href="http://edmondscommerce.github.io/Vim/php-error-checking-in-vim-with-syntastic.html"/>
    <updated>2014-10-16T11:27:40+01:00</updated>
    <id>http://edmondscommerce.github.io/Vim/php-error-checking-in-vim-with-syntastic</id>
    <content type="html"><![CDATA[<p>If you are using Vim for any kind of PHP development work, then you may miss the sanity checking that is included in some IDEs.</p>

<p>However, it possible to add this in using the <a href="https://github.com/scrooloose/syntastic">Syntastic</a>
plug-in. Installation is quite simple and can be handled by any of the common plug-in managers.</p>

<p>It should be noted that the plug-in just calls external checkers, so you will need to have these setup and configured,
but you should have this done already&hellip;</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Test post from michael]]></title>
    <link href="http://edmondscommerce.github.io/testing/test-post-from-michael.html"/>
    <updated>2014-10-16T11:16:14+01:00</updated>
    <id>http://edmondscommerce.github.io/testing/test-post-from-michael</id>
    <content type="html"><![CDATA[<p>Testing blog post</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[This is a test post]]></title>
    <link href="http://edmondscommerce.github.io/testing/this-is-a-test-post.html"/>
    <updated>2014-10-15T18:20:05+01:00</updated>
    <id>http://edmondscommerce.github.io/testing/this-is-a-test-post</id>
    <content type="html"><![CDATA[<p>This is just a test, hello world</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Intermittent PayPal IPN failure in Magento]]></title>
    <link href="http://edmondscommerce.github.io/magento/intermittent-paypal-ipn-failure-in-magento.html"/>
    <updated>2014-10-15T09:53:44+01:00</updated>
    <id>http://edmondscommerce.github.io/magento/intermittent-paypal-ipn-failure-in-magento</id>
    <content type="html"><![CDATA[<p>On one or two store we had an issue with intermittent IPN failures. Some paypal orders would be stuck on the &lsquo;Pending&rsquo; status even if there was a sucessful paypal payment. In the exception logs there would be the following exception being thrown &lsquo;PayPal IPN postback failure. See paypal_unknown_ipn.log for details.&rsquo; on line 156 of app/code/core/Mage/Paypal/Model/Ipn.php.</p>

<h3>What the issue turned out to be</h3>

<p>The issue turned out to be curl adding in extra error. On occasions curl will send the following header &lsquo;Expect: 100&rsquo;. The idea behind that is that rather than curl just send the data. It will send a inital request just to check if the web server will accept the data. Curl will usually fall on this bahaviour if the request is above a certain size.</p>

<p>It turns out that the magento implementation assumes that the response will be consitant. But with the ocasional &lsquo;Expect&rsquo; header bing in the request this is not always the case.</p>

<p>In the _postBack method in the IPN class where it makes the curl post back is recived there is the following code near to the end of the method.</p>

<figure class='code panel panel-default'><figcaption class='panel-heading'><h3 class='panel-title'></h3></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="nv">$response</span> <span class="o">=</span> <span class="nb">preg_split</span><span class="p">(</span><span class="s1">&#39;/^\r?$/m&#39;</span><span class="p">,</span> <span class="nv">$response</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
</span><span class='line'><span class="nv">$response</span> <span class="o">=</span> <span class="nx">trim</span><span class="p">(</span><span class="nv">$response</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
</span></code></pre></td></tr></table></div></figure>


<p>This code assumes the line position of where the &lsquo;VERIFIED&rsquo; line would occur. To resolve the header issue the following code should be used instead.</p>

<figure class='code panel panel-default'><figcaption class='panel-heading'><h3 class='panel-title'></h3></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="nv">$response</span> <span class="o">=</span> <span class="nb">preg_split</span><span class="p">(</span><span class="s1">&#39;/^\r?$/m&#39;</span><span class="p">,</span> <span class="nv">$response</span><span class="p">);</span>
</span><span class='line'><span class="nv">$response</span> <span class="o">=</span> <span class="nx">trim</span><span class="p">(</span><span class="nb">end</span><span class="p">(</span><span class="nv">$response</span><span class="p">));</span>
</span></code></pre></td></tr></table></div></figure>


<p>As the &lsquo;VERIFIED&rsquo; line will always be the last line in the response. Regardless of any extra headers being added. This should resolve the issue but of corse remeber to use the local method and copy the class to the local folder with the correct path before doing the modification.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[SELinux Configuration for Alternative Document Root]]></title>
    <link href="http://edmondscommerce.github.io/linux/selinux-configuration-for-alternative-document-root.html"/>
    <updated>2014-10-04T12:19:52+01:00</updated>
    <id>http://edmondscommerce.github.io/linux/selinux-configuration-for-alternative-document-root</id>
    <content type="html"><![CDATA[<p>SELinux provides a secure and fine grained way of controlling permissions for applications running on Linux. It moves beyond simple users and groups to something a lot more granular.</p>

<p>By default SELinux is configured expecting Apache to be using /var/www as its document root.</p>

<p>If you are using an alternative document root then you might find that Apache is unable to write to folders, even though permissions are correctly configured.</p>

<p>If this is the case, you might think that you should disable SELinux, however a better solution is to correctly configure it.</p>

<p>First of all you should double check what types http has:</p>

<figure class='code panel panel-default'><figcaption class='panel-heading'><h3 class='panel-title'></h3></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>semanage fcontext -l | grep http
</span></code></pre></td></tr></table></div></figure>


<p>We specifically need read/write access so lets grep for that:</p>

<figure class='code panel panel-default'><figcaption class='panel-heading'><h3 class='panel-title'></h3></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>semanage fcontext -l | grep http | grep rw
</span></code></pre></td></tr></table></div></figure>


<p>For me that shows the type: httpd_sys_rw_content_t</p>

<p>We now need to add this to our custom document root:</p>

<figure class='code panel panel-default'><figcaption class='panel-heading'><h3 class='panel-title'></h3></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>semanage fcontext -a -t httpd_sys_rw_content_t ‘/opt/Projects<span class="o">(</span>/.*<span class="o">)</span>?’
</span><span class='line'>restorecon -R -v /opt/Projects/
</span></code></pre></td></tr></table></div></figure>


<p>And then you should be able to run your sites from any folder you like without having to resort to disabling SELinux</p>
]]></content>
  </entry>
  
</feed>
