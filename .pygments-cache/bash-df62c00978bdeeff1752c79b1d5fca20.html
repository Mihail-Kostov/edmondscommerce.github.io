<div class="highlight"><pre><span class="c">#!/bin/bash</span>

<span class="c">###### SETUP ############</span>
<span class="nv">LOG_FOLDER</span><span class="o">=</span>/var/www/vhosts/domain.co.uk/statistics/logs
<span class="nv">ACCESS_LOG</span><span class="o">=</span><span class="nv">$LOG_FOLDER</span>/access_log

<span class="nv">HOW_MANY_ROWS</span><span class="o">=</span>20000



<span class="c">######### FUNCTIONS ##############</span>


<span class="k">function </span>title<span class="o">()</span> <span class="o">{</span>
    <span class="nb">echo</span> <span class="s2">&quot;</span>
<span class="s2">---------------------------------</span>
<span class="s2">$@</span>
<span class="s2">---------------------------------</span>
<span class="s2">&quot;</span>
<span class="o">}</span>

<span class="k">function </span>urls_by_ip<span class="o">()</span> <span class="o">{</span>
    <span class="nb">local </span><span class="nv">IP</span><span class="o">=</span><span class="nv">$1</span>
    tail -5000 <span class="nv">$ACCESS_LOG</span> | awk -v <span class="nv">ip</span><span class="o">=</span><span class="nv">$IP</span> <span class="s1">&#39; $1 ~ ip {freq[$7]++} END {for (x in freq) {print freq[x], x}}&#39;</span> | sort -rn | head -20
<span class="o">}</span>


<span class="k">function </span>ip_addresses_by_user_agent<span class="o">(){</span>
    <span class="nb">local </span><span class="nv">USERAGENT_STRING</span><span class="o">=</span><span class="s2">&quot;$1&quot;</span>
    <span class="nb">local </span><span class="nv">TOP_20_IPS</span><span class="o">=</span><span class="s2">&quot;`tail  -$HOW_MANY_ROWS $ACCESS_LOG | grep &quot;</span><span class="k">${</span><span class="nv">USERAGENT_STRING</span><span class="k">}</span><span class="s2">&quot;  | awk &#39;{freq[$1]++} END {for (x in freq) {print freq[x], x}}&#39; | sort -rn | head -20`&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;$TOP_20_IPS&quot;</span>
<span class="o">}</span>

<span class="c">####### RUN REPORTS #############</span>


title <span class="s2">&quot;top 20 URLs&quot;</span>
<span class="nv">TOP_20_URLS</span><span class="o">=</span><span class="s2">&quot;`tail -$HOW_MANY_ROWS $ACCESS_LOG | awk &#39;{freq[$7]++} END {for (x in freq) {print freq[x], x}}&#39; | sort -rn | head -20`&quot;</span>
<span class="nb">echo</span> <span class="s2">&quot;$TOP_20_URLS&quot;</span>


title <span class="s2">&quot;top 20 URLS excluding POST data&quot;</span>
<span class="nv">TOP_20_URLS_WITHOUT_POST</span><span class="o">=</span><span class="s2">&quot;`tail  -$HOW_MANY_ROWS $ACCESS_LOG | awk -F&quot;</span><span class="o">[</span> ?<span class="o">]</span><span class="s2">&quot; &#39;{freq[$7]++} END {for (x in freq) {print freq[x], x}}&#39; | sort -rn | head -20`&quot;</span>
<span class="nb">echo</span> <span class="s2">&quot;$TOP_20_URLS_WITHOUT_POST&quot;</span>


title <span class="s2">&quot;top 20 IPs&quot;</span>
<span class="nv">TOP_20_IPS</span><span class="o">=</span><span class="s2">&quot;`tail  -$HOW_MANY_ROWS $ACCESS_LOG | awk &#39;{freq[$1]++} END {for (x in freq) {print freq[x], x}}&#39; | sort -rn | head -20`&quot;</span>
<span class="nb">echo</span> <span class="s2">&quot;$TOP_20_IPS&quot;</span>

title <span class="s2">&quot;top 20 user agents&quot;</span>
<span class="nv">TOP_20_USER_AGENTS</span><span class="o">=</span><span class="s2">&quot;`tail  -$HOW_MANY_ROWS $ACCESS_LOG | cut -d\  -f12- | sort | uniq -c | sort -rn | head -20`&quot;</span>
<span class="nb">echo</span> <span class="s2">&quot;$TOP_20_USER_AGENTS&quot;</span>


title <span class="s2">&quot;IP Addresses for Top 3 User Agents&quot;</span>

<span class="k">for</span> <span class="o">((</span><span class="nv">I</span><span class="o">=</span>1; I&lt;<span class="o">=</span>3; I++<span class="o">))</span>
<span class="k">do</span>
<span class="k">    </span><span class="nv">UA</span><span class="o">=</span><span class="s2">&quot;`echo &quot;</span><span class="nv">$TOP_20_USER_AGENTS</span><span class="s2">&quot; | head -n $I | tail -n 1 | awk &#39;{$1=&quot;&quot;; print $0}&#39;`&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;$UA&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;~~~~~~~~~~~~~~~~~~&quot;</span>
    ip_addresses_by_user_agent <span class="s2">&quot;$UA&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;</span>
<span class="s2">    &quot;</span>
<span class="k">done</span>
</pre></div>