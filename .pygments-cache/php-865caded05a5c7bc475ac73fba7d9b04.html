<div class="highlight"><pre><span class="k">function</span> <span class="nf">curl</span><span class="p">(</span><span class="nv">$url</span><span class="p">){</span>
<span class="nv">$go</span> <span class="o">=</span> <span class="nb">curl_init</span><span class="p">(</span><span class="nv">$url</span><span class="p">);</span>
<span class="nb">curl_setopt</span> <span class="p">(</span><span class="nv">$go</span><span class="p">,</span> <span class="nx">CURLOPT_URL</span><span class="p">,</span> <span class="nv">$url</span><span class="p">);</span>
<span class="c1">//follow on location problems</span>

<span class="k">if</span> <span class="p">(</span><span class="nb">ini_get</span><span class="p">(</span><span class="s1">&#39;open_basedir&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="o">&amp;&amp;</span> <span class="nb">ini_get</span><span class="p">(</span><span class="s1">&#39;safe_mode&#39;</span> <span class="o">==</span> <span class="s1">&#39;Off&#39;</span><span class="p">)){</span>

<span class="nb">curl_setopt</span> <span class="p">(</span><span class="nv">$go</span><span class="p">,</span> <span class="nx">CURLOPT_FOLLOWLOCATION</span><span class="p">,</span> <span class="nv">$l</span><span class="p">);</span>

<span class="nv">$syn</span> <span class="o">=</span> <span class="nb">curl_exec</span><span class="p">(</span><span class="nv">$go</span><span class="p">);</span>

<span class="p">}</span><span class="k">else</span><span class="p">{</span>

<span class="nv">$syn</span> <span class="o">=</span> <span class="nx">curl_redir_exec</span><span class="p">(</span><span class="nv">$go</span><span class="p">);</span>

<span class="p">}</span>

<span class="nb">curl_close</span><span class="p">(</span><span class="nv">$go</span><span class="p">);</span>
<span class="k">return</span> <span class="nv">$syn</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">//follow on location problems workaround</span>

<span class="k">function</span> <span class="nf">curl_redir_exec</span><span class="p">(</span><span class="nv">$ch</span><span class="p">)</span>

<span class="p">{</span>

<span class="k">static</span> <span class="nv">$curl_loops</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="k">static</span> <span class="nv">$curl_max_loops</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>

<span class="k">if</span> <span class="p">(</span><span class="nv">$curl_loops</span><span class="o">++</span> <span class="o">&gt;=</span> <span class="nv">$curl_max_loops</span><span class="p">)</span>

<span class="p">{</span>

<span class="nv">$curl_loops</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="k">return</span> <span class="k">FALSE</span><span class="p">;</span>

<span class="p">}</span>

<span class="nb">curl_setopt</span><span class="p">(</span><span class="nv">$ch</span><span class="p">,</span> <span class="nx">CURLOPT_HEADER</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span>

<span class="nb">curl_setopt</span><span class="p">(</span><span class="nv">$ch</span><span class="p">,</span> <span class="nx">CURLOPT_RETURNTRANSFER</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span>

<span class="nv">$data</span> <span class="o">=</span> <span class="nb">curl_exec</span><span class="p">(</span><span class="nv">$ch</span><span class="p">);</span>

<span class="k">list</span><span class="p">(</span><span class="nv">$header</span><span class="p">,</span> <span class="nv">$data</span><span class="p">)</span> <span class="o">=</span> <span class="nb">explode</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nv">$data</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

<span class="nv">$http_code</span> <span class="o">=</span> <span class="nb">curl_getinfo</span><span class="p">(</span><span class="nv">$ch</span><span class="p">,</span> <span class="nx">CURLINFO_HTTP_CODE</span><span class="p">);</span>

<span class="k">if</span> <span class="p">(</span><span class="nv">$http_code</span> <span class="o">==</span> <span class="mi">301</span> <span class="o">||</span> <span class="nv">$http_code</span> <span class="o">==</span> <span class="mi">302</span><span class="p">)</span>

<span class="p">{</span>

<span class="nv">$matches</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>

<span class="nb">preg_match</span><span class="p">(</span><span class="s1">&#39;/Location:(.*?)\n/&#39;</span><span class="p">,</span> <span class="nv">$header</span><span class="p">,</span> <span class="nv">$matches</span><span class="p">);</span>

<span class="nv">$url</span> <span class="o">=</span> <span class="o">@</span><span class="nb">parse_url</span><span class="p">(</span><span class="nx">trim</span><span class="p">(</span><span class="nb">array_pop</span><span class="p">(</span><span class="nv">$matches</span><span class="p">)));</span>

<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$url</span><span class="p">)</span>

<span class="p">{</span>

<span class="c1">//couldn&#39;t process the url to redirect to</span>

<span class="nv">$curl_loops</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="k">return</span> <span class="nv">$data</span><span class="p">;</span>

<span class="p">}</span>

<span class="nv">$last_url</span> <span class="o">=</span> <span class="nb">parse_url</span><span class="p">(</span><span class="nb">curl_getinfo</span><span class="p">(</span><span class="nv">$ch</span><span class="p">,</span> <span class="nx">CURLINFO_EFFECTIVE_URL</span><span class="p">));</span>

<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$url</span><span class="p">[</span><span class="s1">&#39;scheme&#39;</span><span class="p">])</span>

<span class="nv">$url</span><span class="p">[</span><span class="s1">&#39;scheme&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$last_url</span><span class="p">[</span><span class="s1">&#39;scheme&#39;</span><span class="p">];</span>

<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$url</span><span class="p">[</span><span class="s1">&#39;host&#39;</span><span class="p">])</span>

<span class="nv">$url</span><span class="p">[</span><span class="s1">&#39;host&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$last_url</span><span class="p">[</span><span class="s1">&#39;host&#39;</span><span class="p">];</span>

<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$url</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">])</span>

<span class="nv">$url</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$last_url</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">];</span>

<span class="nv">$new_url</span> <span class="o">=</span> <span class="nv">$url</span><span class="p">[</span><span class="s1">&#39;scheme&#39;</span><span class="p">]</span> <span class="o">.</span> <span class="s1">&#39;://&#39;</span> <span class="o">.</span> <span class="nv">$url</span><span class="p">[</span><span class="s1">&#39;host&#39;</span><span class="p">]</span> <span class="o">.</span> <span class="nv">$url</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span> <span class="o">.</span> <span class="p">(</span><span class="nv">$url</span><span class="p">[</span><span class="s1">&#39;query&#39;</span><span class="p">]</span><span class="o">?</span><span class="s1">&#39;?&#39;</span><span class="o">.</span><span class="nv">$url</span><span class="p">[</span><span class="s1">&#39;query&#39;</span><span class="p">]</span><span class="o">:</span><span class="s1">&#39;&#39;</span><span class="p">);</span>

<span class="nb">curl_setopt</span><span class="p">(</span><span class="nv">$ch</span><span class="p">,</span> <span class="nx">CURLOPT_URL</span><span class="p">,</span> <span class="nv">$new_url</span><span class="p">);</span>

<span class="k">return</span> <span class="nx">curl_redir_exec</span><span class="p">(</span><span class="nv">$ch</span><span class="p">);</span>

<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

<span class="nv">$curl_loops</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>

<span class="k">return</span> <span class="nv">$data</span><span class="p">;</span>

<span class="p">}</span>

<span class="p">}</span>
</pre></div>