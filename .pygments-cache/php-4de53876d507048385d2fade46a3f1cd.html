<div class="highlight"><pre><span class="k">include_once</span><span class="p">(</span><span class="s1">&#39;Mage/Cms/controllers/IndexController.php&#39;</span><span class="p">);</span>

<span class="k">class</span> <span class="nc">EdmondsCommerce_Redirects_Cms_IndexController</span> 
<span class="k">extends</span> <span class="nx">Mage_Cms_IndexController</span> <span class="p">{</span>

    <span class="sd">/**</span>
<span class="sd">     * This checks to see if the site can redirect</span>
<span class="sd">     * before displaying a 404</span>
<span class="sd">     * @param type $coreRoute</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">noRouteAction</span><span class="p">(</span><span class="nv">$coreRoute</span> <span class="o">=</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// Get the request</span>
        <span class="nv">$request</span> <span class="o">=</span> <span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">&#39;REQUEST_URI&#39;</span><span class="p">];</span>
        <span class="c1">// Strip off get params if there are any</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">strpos</span><span class="p">(</span><span class="nv">$request</span><span class="p">,</span> <span class="s1">&#39;?&#39;</span><span class="p">)</span> <span class="o">!==</span> <span class="k">FALSE</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$request</span> <span class="o">=</span> <span class="nx">substr</span><span class="p">(</span><span class="nv">$request</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">strpos</span><span class="p">(</span><span class="nv">$request</span><span class="p">,</span> <span class="s1">&#39;?&#39;</span><span class="p">));</span>
        <span class="p">}</span>
        <span class="sd">/**</span>
<span class="sd">         *  This makes sure that no part of the request is included</span>
<span class="sd">         *  in the base url. This should help</span>
<span class="sd">         *  the system work if it is running from a sub folder</span>
<span class="sd">         */</span>
        <span class="nv">$parts</span> <span class="o">=</span> <span class="nb">explode</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="nx">Mage</span><span class="o">::</span><span class="na">getBaseUrl</span><span class="p">());</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$parts</span> <span class="k">AS</span> <span class="nv">$part</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$request</span> <span class="o">=</span> <span class="nb">str_replace</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="nv">$part</span><span class="p">,</span> <span class="s1">&#39;//&#39;</span><span class="p">),</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nv">$request</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="cm">/*</span>
<span class="cm">         * Combine the request with the base path to get the full url</span>
<span class="cm">         * and remove any trailing slashes</span>
<span class="cm">         */</span>
        <span class="nv">$path</span> <span class="o">=</span> <span class="nx">trim</span><span class="p">(</span><span class="nb">str_replace</span><span class="p">(</span><span class="s1">&#39;http:/&#39;</span><span class="p">,</span> <span class="s1">&#39;http://&#39;</span><span class="p">,</span> <span class="nb">str_replace</span><span class="p">(</span><span class="s1">&#39;//&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="nx">Mage</span><span class="o">::</span><span class="na">getBaseUrl</span><span class="p">()</span> <span class="o">.</span> <span class="nv">$request</span><span class="p">)),</span> <span class="s1">&#39;/&#39;</span><span class="p">);</span>
        <span class="c1">//Get the last section which should be the product title</span>
        <span class="nv">$cleanedPath</span> <span class="o">=</span> <span class="nb">explode</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="nv">$path</span><span class="p">);</span>
        <span class="nv">$key</span> <span class="o">=</span> <span class="nb">array_pop</span><span class="p">(</span><span class="nv">$cleanedPath</span><span class="p">);</span>
        <span class="c1">//Here we find url keys like the title</span>
        <span class="nv">$collection</span> <span class="o">=</span> <span class="nx">Mage</span><span class="o">::</span><span class="na">getModel</span><span class="p">(</span><span class="s1">&#39;catalog/product&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">getCollection</span><span class="p">();</span>
        <span class="nv">$collection</span><span class="o">-&gt;</span><span class="na">addAttributeToSelect</span><span class="p">(</span><span class="s1">&#39;url_key&#39;</span><span class="p">);</span>
        <span class="nv">$collection</span><span class="o">-&gt;</span><span class="na">addFieldToFilter</span><span class="p">(</span><span class="k">array</span><span class="p">(</span>
            <span class="k">array</span><span class="p">(</span><span class="s1">&#39;attribute&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;url_key&#39;</span><span class="p">,</span> <span class="s1">&#39;like&#39;</span> <span class="o">=&gt;</span> <span class="s2">&quot;</span><span class="si">$key</span><span class="s2">&quot;</span><span class="p">)));</span>
        <span class="nv">$products</span> <span class="o">=</span> <span class="nv">$collection</span><span class="o">-&gt;</span><span class="na">load</span><span class="p">();</span>
        <span class="cm">/*</span>
<span class="cm">         * Proceed if there is only 1 result, if there are more we</span>
<span class="cm">         * don&#39;t know which one is correct</span>
<span class="cm">         */</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">count</span><span class="p">(</span><span class="nv">$products</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">foreach</span> <span class="p">(</span><span class="nv">$products</span> <span class="k">AS</span> <span class="nv">$product</span><span class="p">)</span> <span class="p">{</span>
                <span class="nv">$url</span> <span class="o">=</span> <span class="nx">Mage</span><span class="o">::</span><span class="na">getBaseUrl</span><span class="p">(</span><span class="nx">Mage_Core_Model_Store</span><span class="o">::</span><span class="na">URL_TYPE_WEB</span><span class="p">)</span> <span class="o">.</span> <span class="nv">$product</span><span class="o">-&gt;</span><span class="na">getUrlKey</span><span class="p">();</span>
                <span class="c1">//Check to make sure the url is not the same as the path, should prevent infinite redirects</span>
                <span class="k">if</span> <span class="p">(</span><span class="nv">$path</span> <span class="o">!=</span> <span class="nv">$url</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">header</span><span class="p">(</span><span class="s1">&#39;HTTP/1.1 301 Moved Permanently&#39;</span><span class="p">);</span>
                    <span class="nx">header</span><span class="p">(</span><span class="s1">&#39;Location: &#39;</span> <span class="o">.</span> <span class="nv">$url</span><span class="p">);</span>
                    <span class="k">die</span><span class="p">();</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="c1">// Could not find a suitable url carry out the 404</span>
        <span class="k">parent</span><span class="o">::</span><span class="na">noRouteAction</span><span class="p">(</span><span class="nv">$coreRoute</span><span class="p">);</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>