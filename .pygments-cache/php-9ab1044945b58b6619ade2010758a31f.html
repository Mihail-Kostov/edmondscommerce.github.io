<div class="highlight"><pre><span class="o">&lt;?</span><span class="nx">php</span>
<span class="nv">$screenwidth</span> <span class="o">=</span> <span class="mi">80</span><span class="p">;</span>
<span class="k">function</span> <span class="nf">trimstr</span><span class="p">(</span><span class="nv">$str</span><span class="p">,</span> <span class="nv">$maxlength</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nv">$middle</span> <span class="o">=</span> <span class="s1">&#39;...&#39;</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">global</span> <span class="nv">$screenwidth</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="nv">$maxlength</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="nv">$maxlength</span> <span class="o">=</span> <span class="nv">$screenwidth</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">count</span><span class="p">(</span><span class="nv">$str</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nv">$maxlength</span><span class="p">)</span> <span class="p">{</span>
		<span class="nv">$partlength</span> <span class="o">=</span> <span class="nx">round</span><span class="p">(</span><span class="nv">$maxlength</span> <span class="o">-</span> <span class="nb">count</span><span class="p">(</span><span class="nv">$middle</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
		<span class="nv">$leftpart</span> <span class="o">=</span> <span class="nx">substr</span><span class="p">(</span><span class="nv">$str</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">$partlength</span><span class="p">);</span>
		<span class="nv">$rightpart</span> <span class="o">=</span> <span class="nx">substr</span><span class="p">(</span><span class="nv">$str</span><span class="p">,</span> <span class="mi">0</span><span class="o">-</span><span class="nv">$partlength</span><span class="p">);</span>
		<span class="k">return</span> <span class="nv">$leftpart</span> <span class="o">.</span> <span class="nv">$middle</span> <span class="o">.</span> <span class="nv">$rightpart</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nv">$str</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="c1">// First we load the sitemap xml</span>
<span class="nv">$xml</span> <span class="o">=</span> <span class="nb">simplexml_load_file</span><span class="p">(</span><span class="nv">$argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<span class="nv">$counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nv">$threadcount</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
<span class="nv">$multihandle</span> <span class="o">=</span> <span class="nb">curl_multi_init</span><span class="p">();</span>
<span class="nv">$fourohfours</span> <span class="o">=</span> <span class="nv">$threeohones</span> <span class="o">=</span> <span class="nv">$twohundreds</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(</span><span class="nv">$xml</span><span class="o">-&gt;</span><span class="na">getName</span><span class="p">()</span> <span class="o">!=</span> <span class="s1">&#39;urlset&#39;</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">die</span><span class="p">(</span><span class="s2">&quot;Doesn&#39;t look like a valid sitemap!&quot;</span><span class="p">);</span>
<span class="p">}</span>
<span class="nv">$total_urls</span> <span class="o">=</span> <span class="nb">count</span><span class="p">(</span><span class="nv">$xml</span><span class="o">-&gt;</span><span class="na">children</span><span class="p">());</span>

<span class="c1">// Then we iterate over it</span>
<span class="k">foreach</span><span class="p">(</span><span class="nv">$xml</span><span class="o">-&gt;</span><span class="na">children</span><span class="p">()</span> <span class="k">as</span> <span class="nv">$child</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="nv">$child</span><span class="o">-&gt;</span><span class="na">getName</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;url&#39;</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">foreach</span> <span class="p">(</span><span class="nv">$child</span><span class="o">-&gt;</span><span class="na">children</span><span class="p">()</span> <span class="k">as</span> <span class="nv">$subchild</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="nv">$subchild</span><span class="o">-&gt;</span><span class="na">getName</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;loc&#39;</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">echo</span> <span class="s2">&quot;Fetching : &quot;</span><span class="o">.</span><span class="nx">trimstr</span><span class="p">(</span><span class="nv">$subchild</span><span class="p">,</span> <span class="nv">$screenwidth</span> <span class="o">-</span> <span class="mi">12</span><span class="p">)</span><span class="o">.</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
				<span class="nv">$counter</span><span class="o">++</span><span class="p">;</span>
				<span class="nx">addurltostack</span><span class="p">(</span><span class="nv">$subchild</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="nv">$counter</span><span class="o">%</span><span class="nv">$threadcount</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="nv">$counter</span> <span class="o">==</span> <span class="nv">$total_urls</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">do</span> <span class="p">{</span>
						<span class="nb">curl_multi_exec</span><span class="p">(</span><span class="nv">$multihandle</span><span class="p">,</span> <span class="nv">$running</span><span class="p">);</span>
					<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="nv">$running</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
					<span class="nx">processresults</span><span class="p">();</span>
					<span class="k">echo</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="nv">$counter</span><span class="o">.</span><span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="nv">$total_urls</span><span class="o">.</span><span class="s1">&#39; urls checked - &#39;</span><span class="o">.</span><span class="nv">$twohundreds</span><span class="o">.</span><span class="s1">&#39; 200s; &#39;</span><span class="o">.</span><span class="nv">$threeohones</span><span class="o">.</span><span class="s1">&#39; 301s; &#39;</span><span class="o">.</span><span class="nv">$fourohfours</span><span class="o">.</span><span class="s1">&#39; 404s.&#39;</span><span class="o">.</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="k">echo</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(</span><span class="nv">$fourohfours</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">echo</span> <span class="s2">&quot;The following urls were 404 returns :- </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
	<span class="k">foreach</span> <span class="p">(</span><span class="nv">$fourohfoururls</span> <span class="k">as</span> <span class="nv">$url</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">echo</span> <span class="nv">$url</span><span class="o">.</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="k">if</span> <span class="p">(</span><span class="nv">$threeohones</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">echo</span> <span class="s2">&quot;The following urls were 301 returns :- </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
	<span class="k">foreach</span> <span class="p">(</span><span class="nv">$threeohoneurls</span> <span class="k">as</span> <span class="nv">$url</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">echo</span> <span class="nv">$url</span><span class="o">.</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="k">function</span> <span class="nf">addurltostack</span><span class="p">(</span><span class="nv">$url</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">global</span> <span class="nv">$curls</span><span class="p">;</span>
	<span class="k">global</span> <span class="nv">$multihandle</span><span class="p">;</span>
	<span class="nv">$ch</span> <span class="o">=</span> <span class="nb">curl_init</span><span class="p">();</span>
	<span class="nv">$curls</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$ch</span><span class="p">;</span>
	<span class="c1">// Set the url path we want to call</span>
	<span class="nb">curl_setopt</span><span class="p">(</span><span class="nv">$ch</span><span class="p">,</span> <span class="nx">CURLOPT_URL</span><span class="p">,</span> <span class="nv">$url</span><span class="p">);</span>
	<span class="c1">// Make it so the data coming back is put into a string</span>
	<span class="nb">curl_setopt</span><span class="p">(</span><span class="nv">$ch</span><span class="p">,</span> <span class="nx">CURLOPT_RETURNTRANSFER</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span> 
	<span class="nb">curl_setopt</span><span class="p">(</span><span class="nv">$ch</span><span class="p">,</span> <span class="nx">CURLOPT_HEADER</span><span class="p">,</span> <span class="k">TRUE</span><span class="p">);</span> 
	<span class="nb">curl_setopt</span><span class="p">(</span><span class="nv">$ch</span><span class="p">,</span> <span class="nx">CURLOPT_NOBODY</span><span class="p">,</span> <span class="k">TRUE</span><span class="p">);</span> <span class="c1">// remove body </span>
	<span class="nb">curl_multi_add_handle</span><span class="p">(</span><span class="nv">$multihandle</span><span class="p">,</span> <span class="nv">$ch</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">function</span> <span class="nf">processresults</span><span class="p">()</span> <span class="p">{</span>
	<span class="k">global</span> <span class="nv">$curls</span><span class="p">;</span>
	<span class="k">global</span> <span class="nv">$multihandle</span><span class="p">;</span>
	<span class="k">global</span> <span class="nv">$fourohfours</span><span class="p">;</span>
	<span class="k">global</span> <span class="nv">$fourohfoururls</span><span class="p">;</span>
	<span class="k">global</span> <span class="nv">$threeohones</span><span class="p">;</span>
	<span class="k">global</span> <span class="nv">$threeohoneurls</span><span class="p">;</span>
	<span class="k">global</span> <span class="nv">$twohundreds</span><span class="p">;</span>
	<span class="k">global</span> <span class="nv">$multihandle</span><span class="p">;</span>
	<span class="k">foreach</span> <span class="p">(</span><span class="nv">$curls</span> <span class="k">as</span> <span class="nv">$ch</span><span class="p">)</span> <span class="p">{</span>
		<span class="nv">$httpCode</span> <span class="o">=</span> <span class="nb">curl_getinfo</span><span class="p">(</span><span class="nv">$ch</span><span class="p">,</span> <span class="nx">CURLINFO_HTTP_CODE</span><span class="p">);</span> 
		<span class="nv">$url</span> <span class="o">=</span> <span class="nb">curl_getinfo</span><span class="p">(</span><span class="nv">$ch</span><span class="p">,</span> <span class="nx">CURLINFO_EFFECTIVE_URL</span><span class="p">);</span> 
		<span class="c1">// Free up the resources $ch is using</span>
		<span class="nb">curl_multi_remove_handle</span><span class="p">(</span><span class="nv">$multihandle</span><span class="p">,</span><span class="nv">$ch</span><span class="p">);</span>
		<span class="nb">curl_close</span><span class="p">(</span><span class="nv">$ch</span><span class="p">);</span>
		<span class="k">switch</span><span class="p">(</span><span class="nv">$httpCode</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">400</span> <span class="o">:</span> 
				<span class="nv">$fourohfours</span><span class="o">++</span><span class="p">;</span>
				<span class="nv">$fourohfoururls</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$url</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">301</span> <span class="o">:</span> 
				<span class="nv">$threeohones</span><span class="o">++</span><span class="p">;</span>
				<span class="nv">$threeohoneurls</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$url</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">200</span> <span class="o">:</span> <span class="nv">$twohundreds</span><span class="o">++</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="nb">curl_multi_close</span><span class="p">(</span><span class="nv">$multihandle</span><span class="p">);</span>
	<span class="nv">$multihandle</span> <span class="o">=</span> <span class="nb">curl_multi_init</span><span class="p">();</span>
	<span class="nv">$curls</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
<span class="p">}</span>
<span class="cp">?&gt;</span><span class="x"></span>
</pre></div>